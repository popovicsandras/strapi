"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[5763],{2498:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>p,contentTitle:()=>o,default:()=>u,frontMatter:()=>i,metadata:()=>s,toc:()=>l});var n=a(3117),r=(a(7294),a(3905));const i={title:"Data Transfer",tags:["testing","e2e","data-transfer","infrastructure"]},o=void 0,s={unversionedId:"guides/e2e/data-transfer",id:"guides/e2e/data-transfer",title:"Data Transfer",description:"Overview",source:"@site/docs/guides/e2e/02-data-transfer.md",sourceDirName:"guides/e2e",slug:"/guides/e2e/data-transfer",permalink:"/guides/e2e/data-transfer",draft:!1,editUrl:"https://github.com/strapi/strapi/tree/main/docs/docs/guides/e2e/02-data-transfer.md",tags:[{label:"testing",permalink:"/tags/testing"},{label:"e2e",permalink:"/tags/e-2-e"},{label:"data-transfer",permalink:"/tags/data-transfer"},{label:"infrastructure",permalink:"/tags/infrastructure"}],version:"current",sidebarPosition:2,frontMatter:{title:"Data Transfer",tags:["testing","e2e","data-transfer","infrastructure"]},sidebar:"guides",previous:{title:"App Template",permalink:"/guides/e2e/app-template"}},p={},l=[{value:"Overview",id:"overview",level:2},{value:"Why use Data Transfer?",id:"why-use-data-transfer",level:2},{value:"Using Data Transfer",id:"using-data-transfer",level:2},{value:"Creating a data packet",id:"creating-a-data-packet",level:3},{value:"Exporting a data packet",id:"exporting-a-data-packet",level:3},{value:"Importing in test scenarios",id:"importing-in-test-scenarios",level:3}],d={toc:l};function u(e){let{components:t,...a}=e;return(0,r.kt)("wrapper",(0,n.Z)({},d,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"overview"},"Overview"),(0,r.kt)("p",null,"This document looks particularly at the ",(0,r.kt)("inlineCode",{parentName:"p"},"@strapi/data-transfer")," package framed around how we use it with our test instances in the e2e test suite. It is not a comprehensive explanation of how to use ",(0,r.kt)("inlineCode",{parentName:"p"},"@strapi/data-transfer"),". For that information you should ",(0,r.kt)("a",{parentName:"p",href:"https://docs.strapi.io/developer-docs/latest/developer-resources/data-management.html"},"view the documentation")," surrounding it."),(0,r.kt)("h2",{id:"why-use-data-transfer"},"Why use Data Transfer?"),(0,r.kt)("p",null,"Each test should be isolated and contained e.g. if you edit an entity in one test, the next test shouldn't know or care about it otherwise your tests need to run in a specific order and become flakey quite quickly."),(0,r.kt)("p",null,"So to solve this, you could use custom API endpoints of the application and whilst this isn't a poor solution it would ",(0,r.kt)("em",{parentName:"p"},"most likely")," require some code writing to set up the data for the schema entries. However, in ",(0,r.kt)("inlineCode",{parentName:"p"},"4.6.0")," Strapi released the ",(0,r.kt)("inlineCode",{parentName:"p"},"DTS")," feature (DTS \u2013 Data Transfer System). This means any member of Strapi can export the data of their instance producing a ",(0,r.kt)("inlineCode",{parentName:"p"},".tar"),' that we can then import programatically restoring the database to this point in time and ensuring a "pure" test environment.'),(0,r.kt)("h2",{id:"using-data-transfer"},"Using Data Transfer"),(0,r.kt)("p",null,"The full documentation of the feature can be seen ",(0,r.kt)("a",{parentName:"p",href:"https://docs.strapi.io/developer-docs/latest/developer-resources/data-management.html"},"here"),". Below are a couple of scenarios you might find yourself."),(0,r.kt)("h3",{id:"creating-a-data-packet"},"Creating a data packet"),(0,r.kt)("p",null,"Because we're using a Strapi template for the test instance, it makes the most sense to add/edit the dataset in said templated instance. Begin by creating the instance:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"yarn test:e2e\n")),(0,r.kt)("p",null,"Then, you should be able to navigate to the app \u2013 ",(0,r.kt)("inlineCode",{parentName:"p"},"cd ./test-apps/test-app-XX"),", the current content schemas should already be defined in there so you will be able to instantly import the current data packet to bring to life the test instance (instead of it being fresh):"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"yarn strapi import --file ../../../e2e/data/<backup-file-name>.tar\n")),(0,r.kt)("p",null,"Once that's completed, you should be able to run your Strapi instance as usual:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"yarn develop\n")),(0,r.kt)("p",null,"If you change any of the content schemas (including adding new ones) be sure to ",(0,r.kt)("a",{parentName:"p",href:"/guides/e2e/app-template"},"update the ",(0,r.kt)("inlineCode",{parentName:"a"},"app-template"))," otherwise DTS will fail to import the data for schemas that do not exist."),(0,r.kt)("h3",{id:"exporting-a-data-packet"},"Exporting a data packet"),(0,r.kt)("p",null,"Once you've created your new data from the test instance, you'll need to export\nit. Since the Strapi CLI will use ",(0,r.kt)("inlineCode",{parentName:"p"},"@strapi/data-transfer")," directly it will by default not export admin users, API tokens, or any other features that have been included in its exclusion list. For this reason, do not use the export command on the strapi test instance. A DTS engine has been created specifically for our tests cases. This allows us to redefine what should be included in the export for our tests. The script can be found in ",(0,r.kt)("inlineCode",{parentName:"p"},"/e2e/scripts/dts-export.js")),(0,r.kt)("p",null,"Be sure to include the content types you would like exported in the ",(0,r.kt)("inlineCode",{parentName:"p"},"ALLOWED_CONTENT_TYPES")," array found in ",(0,r.kt)("inlineCode",{parentName:"p"},"e2e/constants.js"),"."),(0,r.kt)("p",null,"The script accepts the backup destination filename as a parameter. Run it from the directory\nof your strapi test insance to create the backup."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"node <PATH_TO_SCRIPT>/dts-export.js backup-with-admin-user\n")),(0,r.kt)("p",null,"If you are exporting data for an EE feature you will need to run the script with the ",(0,r.kt)("inlineCode",{parentName:"p"},"STRAPI_LICENSE")," env"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"STRAPI_LICENSE=<license-with-ee-feature> node <PATH_TO_SCRIPT>/dts-export.js backup-with-admin-user\n")),(0,r.kt)("p",null,"Once this has been done, add the ",(0,r.kt)("inlineCode",{parentName:"p"},".tar")," backup to ",(0,r.kt)("inlineCode",{parentName:"p"},"/e2e/data")," so the helper\nfunctions can import it correctly."),(0,r.kt)("p",null,"As our suite of e2e tests grows we may hold more DTS backups in order to restore\nthe Strapi application to a desired state prior to testing."),(0,r.kt)("h3",{id:"importing-in-test-scenarios"},"Importing in test scenarios"),(0,r.kt)("p",null,"There's an abstraction for importing the data programmatically during tests named ",(0,r.kt)("inlineCode",{parentName:"p"},"resetDatabaseAndImportDataFromPath")," found in ",(0,r.kt)("inlineCode",{parentName:"p"},"e2e/scripts/dts-import.js"),". Typically, you'll want to run this ",(0,r.kt)("strong",{parentName:"p"},"before")," each test:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts",metastring:"{2,5-8}","{2,5-8}":!0},"import { test } from '@playwright/test';\nimport { resetDatabaseAndImportDataFromPath } from './scripts/dts-import';\n\ntest.describe('Strapi Application', () => {\n  test.beforeEach(async ({ page }) => {\n    await resetDatabaseAndImportDataFromPath('./e2e/data/backup.tar');\n    await page.goto('/admin');\n  });\n\n  test('a user should be able to...', async ({ page }) => {\n    // my test\n  });\n});\n")),(0,r.kt)("p",null,"The path is relative to the root of the strapi project where you called ",(0,r.kt)("inlineCode",{parentName:"p"},"yarn test:e2e"),"."))}u.isMDXComponent=!0},3905:(e,t,a)=>{a.d(t,{Zo:()=>d,kt:()=>m});var n=a(7294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var p=n.createContext({}),l=function(e){var t=n.useContext(p),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},d=function(e){var t=l(e.components);return n.createElement(p.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},c=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,i=e.originalType,p=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),c=l(a),m=r,h=c["".concat(p,".").concat(m)]||c[m]||u[m]||i;return a?n.createElement(h,o(o({ref:t},d),{},{components:a})):n.createElement(h,o({ref:t},d))}));function m(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=a.length,o=new Array(i);o[0]=c;var s={};for(var p in t)hasOwnProperty.call(t,p)&&(s[p]=t[p]);s.originalType=e,s.mdxType="string"==typeof e?e:r,o[1]=s;for(var l=2;l<i;l++)o[l]=a[l];return n.createElement.apply(null,o)}return n.createElement.apply(null,a)}c.displayName="MDXCreateElement"}}]);